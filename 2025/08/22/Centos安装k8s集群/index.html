<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="baidu-site-verification" content="code-wEyWvQMfX7">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"gujincheng.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="æœ¬æ–‡ä¸»è¦åŒ…æ‹¬ï¼š  Centoså®‰è£…k8sé›†ç¾¤">
<meta property="og:type" content="article">
<meta property="og:title" content="Centoså®‰è£…k8sé›†ç¾¤">
<meta property="og:url" content="https://gujincheng.github.io/2025/08/22/Centos%E5%AE%89%E8%A3%85k8s%E9%9B%86%E7%BE%A4/index.html">
<meta property="og:site_name" content="Golden Blog">
<meta property="og:description" content="æœ¬æ–‡ä¸»è¦åŒ…æ‹¬ï¼š  Centoså®‰è£…k8sé›†ç¾¤">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-08-22T02:13:02.000Z">
<meta property="article:modified_time" content="2025-08-25T07:18:56.411Z">
<meta property="article:author" content="Golden">
<meta property="article:tag" content="Kubernetes">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://gujincheng.github.io/2025/08/22/Centos%E5%AE%89%E8%A3%85k8s%E9%9B%86%E7%BE%A4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Centoså®‰è£…k8sé›†ç¾¤ | Golden Blog</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?730b9e375674d8f70a08061cd491e24c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>





  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Golden Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Golden Blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://gujincheng.github.io/2025/08/22/Centos%E5%AE%89%E8%A3%85k8s%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="Golden">
      <meta itemprop="description" content="è®¡åˆ’æ¨åŠ¨å˜åŒ–">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Golden Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Centoså®‰è£…k8sé›†ç¾¤
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-08-22 10:13:02" itemprop="dateCreated datePublished" datetime="2025-08-22T10:13:02+08:00">2025-08-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-25 15:18:56" itemprop="dateModified" datetime="2025-08-25T15:18:56+08:00">2025-08-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
                </span>
            </span>

          
            <span id="/2025/08/22/Centos%E5%AE%89%E8%A3%85k8s%E9%9B%86%E7%BE%A4/" class="post-meta-item leancloud_visitors" data-flag-title="Centoså®‰è£…k8sé›†ç¾¤" title="é˜…è¯»æ¬¡æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/2025/08/22/Centos%E5%AE%89%E8%A3%85k8s%E9%9B%86%E7%BE%A4/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2025/08/22/Centos%E5%AE%89%E8%A3%85k8s%E9%9B%86%E7%BE%A4/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>æœ¬æ–‡ä¸»è¦åŒ…æ‹¬ï¼š</p>
<ul>
<li>Centoså®‰è£…k8sé›†ç¾¤</li>
</ul>
<a id="more"></a>


<h2 id="Centoså®‰è£…k8sé›†ç¾¤"><a href="#Centoså®‰è£…k8sé›†ç¾¤" class="headerlink" title="Centoså®‰è£…k8sé›†ç¾¤"></a>Centoså®‰è£…k8sé›†ç¾¤</h2><h3 id="å®‰è£…ç¯å¢ƒè¯´æ˜"><a href="#å®‰è£…ç¯å¢ƒè¯´æ˜" class="headerlink" title="å®‰è£…ç¯å¢ƒè¯´æ˜"></a>å®‰è£…ç¯å¢ƒè¯´æ˜</h3><p>å†…å­˜ï¼š2GBæˆ–æ›´å¤šRAM<br>CPU: 2æ ¸CPUæˆ–æ›´å¤šCPU<br>ç¡¬ç›˜: 30GBæˆ–æ›´å¤š<br>æœ¬æ¬¡ç¯å¢ƒè¯´æ˜ï¼š<br>æ“ä½œç³»ç»Ÿï¼šCentOS 7.9<br>å†…æ ¸ç‰ˆæœ¬ï¼š3.10.0-1160.el7.x86_64<br>ddp1ï¼š 172.16.7.135<br>ddp2ï¼š 172.16.7.136<br>ddp3ï¼š 172.16.7.137</p>
<h3 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h3><ol>
<li>å…³é—­é˜²ç«å¢™å’Œselinux<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">##å…³é—­é˜²ç«å¢™
systemctl stop firewalld &amp;&amp; systemctl disable firewalld &amp;&amp; iptables -F
## å…³é—­selinux
sed -i &#39;s&#x2F;enforcing&#x2F;disabled&#x2F;&#39; &#x2F;etc&#x2F;selinux&#x2F;config &amp;&amp; setenforce 0
## å…³é—­swapåˆ†åŒº
swapoff -a
## æ°¸ä¹…å…³é—­swap
sed -ri &#39;s&#x2F;.*swap.*&#x2F;#&amp;&#x2F;&#39; &#x2F;etc&#x2F;fstab<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>ä¿®æ”¹hosts</li>
<li>ä¿®æ”¹å†…æ ¸å‚æ•°<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">cat &gt; &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf &lt;&lt; EOF
net.bridge.bridge-nf-call-ip6tables &#x3D; 1
net.bridge.bridge-nf-call-iptables &#x3D; 1
net.ipv4.ip_forward &#x3D; 1
EOF

sysctl --system<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>åŠ è½½ip_vså†…æ ¸æ¨¡å—<br>å¦‚æœkube-proxy æ¨¡å¼ä¸ºip_vsåˆ™å¿…é¡»åŠ è½½ï¼Œæœ¬æ–‡é‡‡ç”¨iptables<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">modprobe ip_vs
modprobe ip_vs_rr
modprobe ip_vs_wrr
modprobe ip_vs_sh
modprobe nf_conntrack_ipv4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
è®¾ç½®ä¸‹æ¬¡å¼€æœºè‡ªåŠ¨åŠ è½½<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">cat &gt; &#x2F;etc&#x2F;modules-load.d&#x2F;ip_vs.conf &lt;&lt; EOF 
ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_sh
nf_conntrack_ipv4
EOF<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="å®‰è£…docker"><a href="#å®‰è£…docker" class="headerlink" title="å®‰è£…docker"></a>å®‰è£…docker</h3></li>
<li>é…ç½®yumæºå¹¶å®‰è£…docker<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">yum install wget -y 
wget https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;docker-ce&#x2F;linux&#x2F;centos&#x2F;docker-ce.repo -O &#x2F;etc&#x2F;yum.repos.d&#x2F;docker-ce.repo
yum install docker-ce docker-ce-cli -y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
<li>ç¼–è¾‘dockeré…ç½®æ–‡ä»¶<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mkdir &#x2F;etc&#x2F;docker&#x2F; 
cat &gt; &#x2F;etc&#x2F;docker&#x2F;daemon.json &lt;&lt; EOF
&#123;
&quot;registry-mirrors&quot;: [&quot;https:&#x2F;&#x2F;gqs7xcfd.mirror.aliyuncs.com&quot;,&quot;https:&#x2F;&#x2F;hub-mirror.c.163.com&quot;],
&quot;exec-opts&quot;: [&quot;native.cgroupdriver&#x3D;systemd&quot;],
&quot;log-driver&quot;: &quot;json-file&quot;,
&quot;log-opts&quot;: &#123;
&quot;max-size&quot;: &quot;100m&quot;
&#125;,
&quot;storage-driver&quot;: &quot;overlay2&quot;
&#125;
EOF<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>å¯åŠ¨dockeræœåŠ¡<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">systemctl daemon-reload &amp;&amp; systemctl enable docker &amp;&amp; systemctl start docker<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="å®‰è£…kubeadm-kubeletå’Œkubectl"><a href="#å®‰è£…kubeadm-kubeletå’Œkubectl" class="headerlink" title="å®‰è£…kubeadm,kubeletå’Œkubectl"></a>å®‰è£…kubeadm,kubeletå’Œkubectl</h3></li>
<li>é…ç½®yumæº(è¿™é‡Œä½¿ç”¨é˜¿é‡Œäº‘çš„æº)<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">cat &gt; &#x2F;etc&#x2F;yum.repos.d&#x2F;kubernetes.repo &lt;&lt; EOF
[kubernetes]
name&#x3D;Kubernetes
baseurl&#x3D;https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;kubernetes&#x2F;yum&#x2F;repos&#x2F;kubernetes-el7-x86_64&#x2F;
enabled&#x3D;1
gpgcheck&#x3D;1
repo_gpgcheck&#x3D;1
gpgkey&#x3D;https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;kubernetes&#x2F;yum&#x2F;doc&#x2F;yum-key.gpg https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;kubernetes&#x2F;yum&#x2F;doc&#x2F;rpm-package-key.gpg
EOF<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„kubeadm,kubelet,kubectl<br>åˆ° <strong>æ‰€æœ‰èŠ‚ç‚¹</strong> æ‰§è¡Œ<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">## åˆ—å‡ºæ‰€æœ‰ç‰ˆæœ¬
yum list kubelet --showduplicates
## å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„kubeadm,kubelet,kubectl
yum install -y kubelet-1.23.6 kubeadm-1.23.6 kubectl-1.23.6<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>è®¾ç½®å¼€æœºè‡ªå¯<br>masterä¸Šéœ€è¦kubeadm initä¹‹åæ‰èƒ½å¯åŠ¨ï¼Œworkeréœ€è¦kubeadm joinä¹‹åæ‰èƒ½å¯åŠ¨<br>æ‰€ä»¥è¿™é‡Œåº”è¯¥æ˜¯è¦æœ€åé…ç½®çš„<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">systemctl start kubelet
systemctl enable kubelet<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
æ¯ä¸ªèŠ‚ç‚¹ï¼ˆä¸ç®¡æ˜¯ Master è¿˜æ˜¯ Workerï¼‰éƒ½å¿…é¡»è¿è¡Œ kubeletï¼Œå¦åˆ™è¯¥èŠ‚ç‚¹æ— æ³•æ­£å¸¸å·¥ä½œï¼ŒKubernetes é›†ç¾¤ä¹Ÿå°±æ— æ³•å®Œæ•´è¿è¡Œï¼</li>
</ol>
<p>è¿™é‡Œå¯åŠ¨æŠ¥é”™ï¼š</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">Aug 22 11:42:57 ddp1 kubelet[24473]: I0822 11:42:57.353755   24473 dynamic_cafile_content.go:156] &quot;Starting controller&quot; name&#x3D;&quot;client-ca-bundle::&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca.crt&quot;
Aug 22 11:42:57 ddp1 kubelet[24473]: I0822 11:42:57.397684   24473 server.go:693] &quot;--cgroups-per-qos enabled, but --cgroup-root was not specified.  defaulting to &#x2F;&quot;
Aug 22 11:42:57 ddp1 kubelet[24473]: E0822 11:42:57.397788   24473 server.go:302] &quot;Failed to run kubelet&quot; err&#x3D;&quot;failed to run Kubelet: running with swap on is not supported, please disable swap! or set --fail-swap-on flag to false. &#x2F;proc&#x2F;swaps contained: [Filename\t\t\t\tType\t\tSize\tUsed\tPriority &#x2F;dev&#x2F;dm-1                               partition\t8257532\t0\t-2]&quot;
Aug 22 11:42:57 ddp1 systemd[1]: kubelet.service: main process exited, code&#x3D;exited, status&#x3D;1&#x2F;FAILURE
Aug 22 11:42:57 ddp1 systemd[1]: Unit kubelet.service entered failed state.
Aug 22 11:42:57 ddp1 systemd[1]: kubelet.service failed.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>é—®é¢˜åŸå› ï¼š</strong> Kubelet ä¸æ”¯æŒåœ¨å¼€å¯ Swap çš„ç³»ç»Ÿä¸Šè¿è¡Œ<br>å†æ¬¡æŠ¥é”™ï¼š</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">Aug 22 11:47:03 ddp1 kubelet[26583]: I0822 11:47:03.411512   26583 docker_service.go:264] &quot;Docker Info&quot; dockerInfo&#x3D;&amp;&#123;ID:5ce8744d-378e-496b-8dd0-25daa6df788c Containers:0 ContainersRunning:0 ContainersPaused:0 ContainersStopped:0 Images:7 Driver:overlay2 DriverStatus:[[Backing Filesystem xfs] [Supports d_type true] [Using metacopy false] [Native Overlay Diff true] [userxattr false]] SystemStatus:[] Plugins:&#123;Volume:[local] Network:[bridge host ipvlan macvlan null overlay] Authorization:[] Log:[awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog]&#125; MemoryLimit:true SwapLimit:true KernelMemory:true KernelMemoryTCP:true CPUCfsPeriod:true CPUCfsQuota:true CPUShares:true CPUSet:true PidsLimit:true IPv4Forwarding:true BridgeNfIptables:true BridgeNfIP6tables:true Debug:false NFd:24 OomKillDisable:true NGoroutines:35 SystemTime:2025-08-22T11:47:03.406858121+08:00 LoggingDriver:json-file CgroupDriver:cgroupfs CgroupVersion:1 NEventsListener:0 KernelVersion:3.10.0-1160.el7.x86_64 OperatingSystem:CentOS Linux 7 (Core) OSVersion:7 OSType:linux Architecture:x86_64 IndexServerAddress:https:&#x2F;&#x2F;index.docker.io&#x2F;v1&#x2F; RegistryConfig:0xc00017c770 NCPU:8 MemTotal:16655888384 GenericResources:[] DockerRootDir:&#x2F;var&#x2F;lib&#x2F;docker HTTPProxy: HTTPSProxy: NoProxy: Name:ddp1 Labels:[] ExperimentalBuild:false ServerVersion:24.0.7 ClusterStore: ClusterAdvertise: Runtimes:map[io.containerd.runc.v2:&#123;Path:runc Args:[] Shim:&lt;nil&gt;&#125; runc:&#123;Path:runc Args:[] Shim:&lt;nil&gt;&#125;] DefaultRuntime:runc Swarm:&#123;NodeID: NodeAddr: LocalNodeState:inactive ControlAvailable:false Error: RemoteManagers:[] Nodes:0 Managers:0 Cluster:&lt;nil&gt; Warnings:[]&#125; LiveRestoreEnabled:false Isolation: InitBinary:docker-init ContainerdCommit:&#123;ID:61f9fd88f79f081d64d6fa3bb1a0dc71ec870523 Expected:61f9fd88f79f081d64d6fa3bb1a0dc71ec870523&#125; RuncCommit:&#123;ID:v1.1.9-0-gccaecfc Expected:v1.1.9-0-gccaecfc&#125; InitCommit:&#123;ID:de40ad0 Expected:de40ad0&#125; SecurityOptions:[name&#x3D;seccomp,profile&#x3D;builtin] ProductLicense: DefaultAddressPools:[] Warnings:[]&#125;
Aug 22 11:47:03 ddp1 kubelet[26583]: E0822 11:47:03.411538   26583 server.go:302] &quot;Failed to run kubelet&quot; err&#x3D;&quot;failed to run Kubelet: misconfiguration: kubelet cgroup driver: \&quot;systemd\&quot; is different from docker cgroup driver: \&quot;cgroupfs\&quot;&quot;
Aug 22 11:47:03 ddp1 systemd[1]: kubelet.service: main process exited, code&#x3D;exited, status&#x3D;1&#x2F;FAILURE
Aug 22 11:47:03 ddp1 systemd[1]: Unit kubelet.service entered failed state.
Aug 22 11:47:03 ddp1 systemd[1]: kubelet.service failed.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ ¹æœ¬åŸå› ï¼šKubelet çš„ cgroup é©±åŠ¨æ˜¯ â€œsystemdâ€ï¼Œä½† Docker å®¹å™¨è¿è¡Œæ—¶ä½¿ç”¨çš„ cgroup é©±åŠ¨æ˜¯ â€œcgroupfsâ€ï¼Œä¸¤è€…ä¸ä¸€è‡´ï¼Œå¯¼è‡´ kubelet æ‹’ç»å¯åŠ¨ï¼<br>è§£å†³æ–¹æ¡ˆï¼šé…ç½®Dockerä½¿ç”¨systemdä½œä¸ºé»˜è®¤Cgroupé©±åŠ¨ï¼Œé…ç½®ä¹‹åéœ€è¦é‡å¯docker</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">cat &lt;&lt;EOF &gt; &#x2F;etc&#x2F;docker&#x2F;daemon.json
&#123;
	&quot;registry-mirrors&quot;: [
        &quot;http:&#x2F;&#x2F;hub-mirror.c.163.com&quot;,
        &quot;https:&#x2F;&#x2F;docker.mirrors.ustc.edu.cn&quot;,
        &quot;https:&#x2F;&#x2F;registry.docker-cn.com&quot;,
        &quot;https:&#x2F;&#x2F;docker.m.daocloud.io&quot;,
        &quot;https:&#x2F;&#x2F;f6qc86pg.mirror.aliyuncs.com&quot;
    ],
	&quot;exec-opts&quot;: [&quot;native.cgroupdriver&#x3D;systemd&quot;]
&#125;
EOF
#é‡å¯docker
systemctl restart docker<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="éƒ¨ç½²Kubernetes-MasterèŠ‚ç‚¹"><a href="#éƒ¨ç½²Kubernetes-MasterèŠ‚ç‚¹" class="headerlink" title="éƒ¨ç½²Kubernetes MasterèŠ‚ç‚¹"></a>éƒ¨ç½²Kubernetes MasterèŠ‚ç‚¹</h3><p>åœ¨Kubernetesä¸­MasterèŠ‚ç‚¹æ˜¯é›†ç¾¤çš„æ§åˆ¶èŠ‚ç‚¹ï¼Œå®ƒæ˜¯ç”±ä¸‰ä¸ªç´§å¯†åä½œçš„ç‹¬ç«‹ç»„ä»¶ç»„åˆè€Œæˆï¼Œåˆ†åˆ«æ˜¯è´Ÿè´£APIæœåŠ¡çš„kube-apiserverã€è´Ÿè´£è°ƒåº¦çš„kube-schedulerä»¥åŠè´Ÿè´£å®¹å™¨ç¼–æ’çš„kube-controller-managerï¼Œå…¶ä¸­æ•´ä¸ªé›†ç¾¤çš„æŒä¹…åŒ–æ•°æ®ç”±kube-apiserverå¤„ç†åä¿å­˜åœ¨Etcdä¸­</p>
<ol>
<li>masterèŠ‚ç‚¹åˆå§‹åŒ–<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubeadm init \
  --kubernetes-version 1.23.6 \
  --apiserver-advertise-address&#x3D;172.16.7.135 \
  --service-cidr&#x3D;10.1.0.0&#x2F;12 \
  --pod-network-cidr&#x3D;192.168.0.0&#x2F;16 \
  --control-plane-endpoint&#x3D;172.16.7.135:6443 \
  --image-repository registry.aliyuncs.com&#x2F;google_containers \
  --upload-certs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
å‚æ•°è¯´æ˜:</li>
</ol>
<p>â€“kubernetes-version: æŒ‡å®šç‰ˆæœ¬<br>â€“image-repositoryï¼šé•œåƒä»“åº“ï¼Œç¦»çº¿å®‰è£…éœ€è¦æŠŠç›¸å…³é•œåƒå…ˆæ‹‰å–ä¸‹æ¥ï¼Œä¸”æ­¤å¤„æ— éœ€å†é…ç½®<br>â€“apiserver-advertise-addressï¼šé›†ç¾¤é€šå‘Šåœ°å€,ä¸ºé€šå‘Šç»™å…¶å®ƒç»„ä»¶çš„IPï¼Œä¸€èˆ¬åº”ä¸ºmasterèŠ‚ç‚¹çš„IPåœ°å€<br>â€“image-repositoryï¼šç”±äºé»˜è®¤æ‹‰å–é•œåƒåœ°å€k8s.gcr.ioå›½å†…æ— æ³•è®¿é—®ï¼Œè¿™é‡ŒæŒ‡å®šé•œåƒä»“åº“åœ°å€<br>â€“kubernetes-versionï¼šK8sç‰ˆæœ¬ï¼Œä¸ä¸Šé¢å®‰è£…çš„ä¸€è‡´<br>â€“service-cidrï¼šé›†ç¾¤å†…éƒ¨è™šæ‹Ÿç½‘ç»œï¼ŒPodç»Ÿä¸€è®¿é—®å…¥å£<br>â€“pod-network-cidrï¼šPodç½‘ç»œï¼Œæœ‰ä¸¤ä¸ªå€¼ï¼Œæ‰“ç®—ä½¿ç”¨calicoç½‘ç»œæ’ä»¶æ—¶ï¼Œæœ€å¥½ä½¿ç”¨10.96.0.0/16ï¼Œ192.168.0.0/16ï¼Œæ‰“ç®—ä½¿ç”¨flannelç½‘ç»œæ’ä»¶æ—¶æœ€å¥½ä½¿ç”¨10.244.0.0/16<br>â€“control-plane-endpoint: è¯¥å‚æ•°ç”¨äºå®šä¹‰ä¸€ä¸ªç¨³å®šçš„è®¿é—®ç«¯ç‚¹ï¼ˆé€šå¸¸æ˜¯è´Ÿè½½å‡è¡¡å™¨åœ°å€æˆ– DNS åç§°ï¼‰ï¼Œæ‰€æœ‰å·¥ä½œèŠ‚ç‚¹å’Œå…¶ä»–æ§åˆ¶å¹³é¢èŠ‚ç‚¹éƒ½é€šè¿‡è¿™ä¸ªç«¯ç‚¹ä¸é›†ç¾¤é€šä¿¡ã€‚åœ¨ HA é›†ç¾¤ä¸­ï¼Œå¿…é¡»é…ç½®ã€‚<br>â€“upload-certsï¼šè‡ªåŠ¨åˆ†å‘è¯ä¹¦ä¾›å…¶ä»–æ§åˆ¶å¹³é¢èŠ‚ç‚¹åŠ å…¥</p>
<p><strong>æ³¨æ„ï¼š</strong> </p>
<ol>
<li>ç‰ˆæœ¬å¿…é¡»å’Œä¸Šè¾¹å®‰è£…çš„kubelet,kubead,kubectlä¿æŒä¸€è‡´</li>
<li>kubeadm init åªéœ€è¦åœ¨masterä¸Šæ‰§è¡Œå³å¯ï¼Œworkerä¸Šä¸éœ€è¦æ‰§è¡Œ</li>
</ol>
<p>åˆå§‹åŒ–è¿‡ç¨‹ä¸­å¯èƒ½å­˜åœ¨è¶…æ—¶é”™è¯¯ï¼Œæ­¤æ—¶éœ€ä¿®æ”¹é…ç½®åé‡æ–°åˆå§‹åŒ–</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># ä¿®æ”¹ç³»ç»Ÿå¯åŠ¨æ–‡ä»¶
vi &#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kubelet.service
[Service]
ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;kubelet --kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;kubelet.conf --config&#x3D;&#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;config.yaml

# éœ€è¦å›é€€åˆå§‹åŒ–è¿‡ç¨‹åå†é‡æ–°åˆå§‹åŒ–
kubeadm reset<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åˆå§‹åŒ–æˆåŠŸæ—¥å¿—ï¼š</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">Your Kubernetes control-plane has initialized successfully!
To start using your cluster, you need to run the following as a regular user:
  mkdir -p $HOME&#x2F;.kube
  sudo cp -i &#x2F;etc&#x2F;kubernetes&#x2F;admin.conf $HOME&#x2F;.kube&#x2F;config
  sudo chown $(id -u):$(id -g) $HOME&#x2F;.kube&#x2F;config
Alternatively, if you are the root user, you can run:
  export KUBECONFIG&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;admin.conf
You should now deploy a pod network to the cluster.
Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:
  https:&#x2F;&#x2F;kubernetes.io&#x2F;docs&#x2F;concepts&#x2F;cluster-administration&#x2F;addons&#x2F;
You can now join any number of the control-plane node running the following command on each as root:
  kubeadm join 172.16.7.135:6443 --token df0fp8.qqn7ph60hnglskol \
        --discovery-token-ca-cert-hash sha256:6230f41413e2cdaf154d7d95b914984a1eb1ddf79d814f166c57156026fd78e2 \
        --control-plane --certificate-key d57db043a3b8e97392bd7415a884ad0fb5c2b9697fafe61416340cca56228b17
Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use
&quot;kubeadm init phase upload-certs --upload-certs&quot; to reload certs afterward.
Then you can join any number of worker nodes by running the following on each as root:
kubeadm join 172.16.7.135:6443 --token df0fp8.qqn7ph60hnglskol \
        --discovery-token-ca-cert-hash sha256:6230f41413e2cdaf154d7d95b914984a1eb1ddf79d814f166c57156026fd78e2 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨masterä¸Šæ‰§è¡Œï¼š<br>å¦‚æœæ˜¯æ™®é€šç”¨æˆ·ï¼Œå¯ä»¥æ‰§è¡Œï¼š</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mkdir -p $HOME&#x2F;.kube
sudo cp -i &#x2F;etc&#x2F;kubernetes&#x2F;admin.conf $HOME&#x2F;.kube&#x2F;config
sudo chown $(id -u):$(id -g) $HOME&#x2F;.kube&#x2F;config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>å¦‚æœæ˜¯rootç”¨æˆ·ï¼Œå¯ä»¥æ‰§è¡Œ<code>export KUBECONFIG=/etc/kubernetes/admin.conf</code></p>
<h3 id="éƒ¨ç½²workerèŠ‚ç‚¹"><a href="#éƒ¨ç½²workerèŠ‚ç‚¹" class="headerlink" title="éƒ¨ç½²workerèŠ‚ç‚¹"></a>éƒ¨ç½²workerèŠ‚ç‚¹</h3><p>å‰ææ¡ä»¶ï¼š</p>
<ol>
<li>å®‰è£…äº†kubelet-1.23.6 kubeadm-1.23.6 kubectl-1.23.6</li>
<li>å®‰è£…äº†dockerå¹¶å·²å¯åŠ¨</li>
<li>é…ç½®Dockerä½¿ç”¨systemdä½œä¸ºé»˜è®¤Cgroupé©±åŠ¨ï¼Œé…ç½®ä¹‹åéœ€è¦é‡å¯docker<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubeadm join 172.16.7.135:6443 --token df0fp8.qqn7ph60hnglskol \
        --discovery-token-ca-cert-hash sha256:6230f41413e2cdaf154d7d95b914984a1eb1ddf79d814f166c57156026fd78e2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
åŠ å…¥æˆåŠŸï¼š<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.
Run &#39;kubectl get nodes&#39; on the control-plane to see this node join the cluster.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
åœ¨æ‰€æœ‰workerä¸Šæ‰§è¡Œï¼š<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mkdir -p $HOME&#x2F;.kube
scp ddp1:&#x2F;etc&#x2F;kubernetes&#x2F;admin.conf $HOME&#x2F;.kube&#x2F;config
sudo chown $(id -u):$(id -g) $HOME&#x2F;.kube&#x2F;config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
æ‰§è¡Œå®ŒæˆåæŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹ï¼Œæ­¤æ—¶å‡ä¸ºNotReadyçŠ¶æ€ï¼Œå¾…åé¢ç½‘ç»œæ’ä»¶Calicoå®‰è£…å®Œæˆåï¼Œä¼šå˜æˆReadyçŠ¶æ€<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@ddp1 ~]# kubectl get nodes
NAME   STATUS     ROLES                  AGE   VERSION
ddp1   NotReady   control-plane,master   45m   v1.23.6
ddp2   NotReady   &lt;none&gt;                 15m   v1.23.6
ddp3   NotReady   &lt;none&gt;                 13m   v1.23.6<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="åç»­é…ç½®"><a href="#åç»­é…ç½®" class="headerlink" title="åç»­é…ç½®"></a>åç»­é…ç½®</h3>Master èŠ‚ç‚¹ï¼ˆControl Plane èŠ‚ç‚¹ï¼‰ï¼š é»˜è®¤æƒ…å†µä¸‹ï¼ŒMaster èŠ‚ç‚¹ä¼šè¢«æ ‡è®°ä¸ºä¸å¯è°ƒåº¦ï¼ˆunschedulableï¼‰ï¼Œå³ä¸å…è®¸æ™®é€š Pod è·‘åœ¨ä¸Šé¢<br>Worker èŠ‚ç‚¹ï¼ˆNode èŠ‚ç‚¹ï¼‰ï¼šè´Ÿè´£è¿è¡Œä½ çš„ ä¸šåŠ¡ Podï¼Œæ¯”å¦‚ Deploymentã€StatefulSetã€DaemonSet åˆ›å»ºçš„å®¹å™¨<br>Master èŠ‚ç‚¹åœ¨åˆå§‹åŒ–æ—¶ï¼ˆæ¯”å¦‚è¿è¡Œ kubeadm initï¼‰ï¼Œä¼šè‡ªåŠ¨ç»™å®ƒæ‰“ä¸Šä¸€ä¸ªæ±¡ç‚¹ï¼ˆTaintï¼‰ï¼Œç”¨æ¥é˜»æ­¢æ™®é€š Pod è°ƒåº¦ä¸Šå»ã€‚<br>åœ¨é›†ç¾¤èµ„æºæœ‰é™çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ é…ç½®MasterèŠ‚ç‚¹ä¹Ÿä½œä¸ºNodeèŠ‚ç‚¹ï¼Œç§»é™¤MasterèŠ‚ç‚¹çš„åäº²å’Œæ€§<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@ddp1 ~]# kubectl taint node --all node-role.kubernetes.io&#x2F;master-
node&#x2F;ddp1 untainted
taint &quot;node-role.kubernetes.io&#x2F;master&quot; not found
taint &quot;node-role.kubernetes.io&#x2F;master&quot; not found<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

</li>
</ol>
<h3 id="å®‰è£…Calicoæ’ä»¶"><a href="#å®‰è£…Calicoæ’ä»¶" class="headerlink" title="å®‰è£…Calicoæ’ä»¶"></a>å®‰è£…Calicoæ’ä»¶</h3><p>ç½‘ç»œæ’ä»¶æ˜¯å¿…è¦éƒ¨ä»¶ï¼Œå¸¸ç”¨çš„æœ‰Flannelã€Calicoç­‰ã€‚äº‘å‚å•†ä¸€èˆ¬æ˜¯ç»“åˆVPCæœ‰è‡ªå·±çš„ä¸€å¥—å®ç°ã€‚<br>CNI å…¨ç§°æ˜¯â€œContainer Networking Interfaceâ€ï¼Œå³å®¹å™¨ç½‘ç»œæ¥å£ï¼Œå®ƒæä¾›äº†ä¸€ç§æ ‡å‡†çš„æ’ä»¶æœºåˆ¶ï¼Œç”¨äºè¿æ¥å®¹å™¨åˆ°åº•å±‚ç½‘ç»œä¸­ã€‚CNI æ’ä»¶æ˜¯ä¸€ç§å¯æ‰§è¡Œç¨‹åºï¼Œå®ƒå°†å®ç°å®¹å™¨ç½‘ç»œè¿æ¥çš„ä¸€äº›é€»è¾‘æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œå…è®¸å®¹å™¨ä½¿ç”¨ä¸åŒçš„ç½‘ç»œæ¨¡å‹ï¼Œå¹¶æä¾›äº†ä¸€ç»„ç½‘ç»œæŠ½è±¡æ¥å£ã€‚åœ¨ Kubernetes ç­‰å®¹å™¨ç¼–æ’å¹³å°ä¸­ï¼ŒCNI æ’ä»¶è¢«å¹¿æ³›ä½¿ç”¨æ¥å®ç°å®¹å™¨ç½‘ç»œã€‚<br>CNI æ’ä»¶å¯ä»¥ç”±ç¬¬ä¸‰æ–¹å‚å•†å¼€å‘å’Œç»´æŠ¤ï¼Œå› æ­¤ï¼Œå¯ä»¥é€‰æ‹©æœ€é€‚åˆè‡ªå·±çš„æ’ä»¶ã€‚CNI æ’ä»¶é€šå¸¸è¿è¡Œåœ¨ä¸»æœºä¸Šï¼Œå¹¶ç”±å®¹å™¨è¿è¡Œæ—¶è°ƒç”¨ï¼Œä¾‹å¦‚ Dockerã€rkt ç­‰ã€‚å½“å®¹å™¨éœ€è¦è¿æ¥åˆ°ä¸»æœºç½‘ç»œæ—¶ï¼ŒCNI æ’ä»¶å°†ä¼šä¸ºå…¶åˆ›å»ºå¿…è¦çš„ç½‘ç»œæ¥å£å’Œè·¯ç”±è§„åˆ™ã€‚<br>ä¸€äº›å¸¸ç”¨çš„ CNI æ’ä»¶åŒ…æ‹¬ï¼š<br>Flannelï¼šä¸€ä¸ªç®€å•æ˜“ç”¨çš„ç½‘ç»œè§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒå¤šç§éƒ¨ç½²æ¨¡å¼ã€‚<br>Calicoï¼šä¸€ä¸ªé«˜åº¦å¯æ‰©å±•çš„å®¹å™¨ç½‘ç»œæ–¹æ¡ˆï¼Œæ—¨åœ¨ä¸ºå¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒæä¾›ç½‘ç»œå’Œå®‰å…¨æ€§ã€‚<br>Weave Netï¼šä¸€ä¸ªåˆ†å¸ƒå¼çš„å®¹å™¨ç½‘ç»œæ–¹æ¡ˆï¼Œå…·æœ‰è‰¯å¥½çš„å¯æ‰©å±•æ€§å’Œé«˜åº¦è‡ªåŠ¨åŒ–çš„ç®¡ç†ã€‚<br>Ciliumï¼šä¸€ä¸ªåŸºäº eBPF çš„å®¹å™¨ç½‘ç»œå’Œå®‰å…¨è§£å†³æ–¹æ¡ˆï¼Œæä¾›å¼ºå¤§çš„æµé‡æ§åˆ¶å’Œå®‰å…¨æ€§ã€‚<br>å®‰è£…å…¶ä¸­ä¸€ç§ç½‘ç»œæ’ä»¶å³å¯ã€‚æœ¬æ–‡ä½¿ç”¨äº† Calicoï¼Œå»ºè®®ä½¿ç”¨ Flannelï¼›ä½¿ç”¨Calicoå¯èƒ½ä¼šå­˜åœ¨ centos ç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬é—®é¢˜</p>
<h4 id="ç¦»çº¿å®‰è£…ï¼š"><a href="#ç¦»çº¿å®‰è£…ï¼š" class="headerlink" title="ç¦»çº¿å®‰è£…ï¼š"></a>ç¦»çº¿å®‰è£…ï¼š</h4><p>æå‰å‡†å¤‡å¥½calicoçš„ç›¸å…³images<br>åœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">cd calico
docker load -i cni-3.25.0.tar
docker load -i node-3.25.0.tar
docker load -i kube-controllers-3.25.0.tar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¿®æ”¹é…ç½®æ–‡ä»¶calico.yaml(å®‰è£…åŒ…ä¸­å·²ä¿®æ”¹ï¼Œä¸€èˆ¬æ— éœ€å†ä¿®æ”¹)</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># å–æ¶ˆå¦‚ä¸‹æ³¨é‡Šï¼Œvalueä¿®æ”¹ä¸ºkubeadmåˆå§‹åŒ–æ—¶--pod-network-cidrå‚æ•°æŒ‡å®šçš„ç½‘æ®µ
- name: CALICO_IPV4POOL_CIDR
  value: &quot;192.168.0.0&#x2F;16&quot;
  
# æ‰¾åˆ°é…ç½®æ–‡ä»¶çš„è¿™ä¸ªä½ç½®ï¼Œåœ¨ä¸‹æ–¹æ·»åŠ é…ç½®
    - name: CLUSTER_TYPE
      value: &quot;k8s,bgp&quot;
# åœ¨ä¸‹é¢æ·»åŠ 
    - name: IP_AUTODETECTION_METHOD
      value: &quot;interface&#x3D;enp0s3&quot;	# enp0s3ä¸ºæœ¬åœ°ç½‘å¡å<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨MasterèŠ‚ç‚¹æ‰§è¡Œ<br>å®‰è£…Calico<br><code>kubectl apply -f calico.yaml</code><br>å®‰è£…å®Œæˆï¼Œç¨ç­‰ç‰‡åˆ»åæŸ¥çœ‹nodeï¼Œå¯ä»¥çœ‹åˆ°æ‰€æœ‰èŠ‚ç‚¹å‡ä¸ºReadyçŠ¶æ€</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@ddp1 calico]# kubectl get node
NAME   STATUS   ROLES                  AGE    VERSION
ddp1   Ready    control-plane,master   179m   v1.23.6
ddp2   Ready    &lt;none&gt;                 148m   v1.23.6
ddp3   Ready    &lt;none&gt;                 147m   v1.23.6<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="åœ¨çº¿å®‰è£…"><a href="#åœ¨çº¿å®‰è£…" class="headerlink" title="åœ¨çº¿å®‰è£…"></a>åœ¨çº¿å®‰è£…</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">wget --no-check-certificate https:&#x2F;&#x2F;docs.projectcalico.org&#x2F;manifests&#x2F;calico.yaml
grep image: calico.yaml

docker pull calico&#x2F;cni:v3.25.0
docker pull calico&#x2F;node:v3.25.0
docker pull calico&#x2F;kube-controllers:v3.25.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¿®æ”¹é…ç½®æ–‡ä»¶calico.yaml</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># å–æ¶ˆå¦‚ä¸‹æ³¨é‡Šï¼Œvalueä¿®æ”¹ä¸ºkubeadmåˆå§‹åŒ–æ—¶--pod-network-cidrå‚æ•°æŒ‡å®šçš„ç½‘æ®µ
- name: CALICO_IPV4POOL_CIDR
  value: &quot;192.168.0.0&#x2F;16&quot;

# æ‰¾åˆ°é…ç½®æ–‡ä»¶çš„è¿™ä¸ªä½ç½®ï¼Œåœ¨ä¸‹æ–¹æ·»åŠ é…ç½®
    - name: CLUSTER_TYPE
      value: &quot;k8s,bgp&quot;
# åœ¨ä¸‹é¢æ·»åŠ 
    - name: IP_AUTODETECTION_METHOD
      value: &quot;interface&#x3D;enp0s3&quot;	# enp0s3ä¸ºæœ¬åœ°ç½‘å¡å<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å®‰è£…Calico<br><code>kubectl apply -f calico.yaml</code><br>å®‰è£…å®Œæˆåï¼ŒæŸ¥çœ‹nodeï¼Œå¯ä»¥çœ‹åˆ°æ‰€æœ‰èŠ‚ç‚¹å‡ä¸ºReadyçŠ¶æ€</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@ddp1 calico]# kubectl get node
NAME   STATUS   ROLES                  AGE    VERSION
ddp1   Ready    control-plane,master   179m   v1.23.6
ddp2   Ready    &lt;none&gt;                 148m   v1.23.6
ddp3   Ready    &lt;none&gt;                 147m   v1.23.6<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="æŸ¥çœ‹podå®‰è£…æƒ…å†µ"><a href="#æŸ¥çœ‹podå®‰è£…æƒ…å†µ" class="headerlink" title="æŸ¥çœ‹podå®‰è£…æƒ…å†µ"></a>æŸ¥çœ‹podå®‰è£…æƒ…å†µ</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">root@ddp1 calico]# kubectl get pods -n kube-system
NAME                                       READY   STATUS              RESTARTS      AGE
calico-kube-controllers-64cc74d646-bprpr   0&#x2F;1     ContainerCreating   0             9s
calico-node-cqjw7                          0&#x2F;1     Running             0             9s
calico-node-n7zzs                          0&#x2F;1     Running             0             9s
calico-node-t42pq                          0&#x2F;1     Init:0&#x2F;3            0             9s
coredns-6d8c4cb4d-78dd7                    1&#x2F;1     Running             0             177m
coredns-6d8c4cb4d-t8msr                    1&#x2F;1     Running             0             177m
etcd-ddp1                                  1&#x2F;1     Running             5 (62m ago)   178m
kube-apiserver-ddp1                        1&#x2F;1     Running             5 (62m ago)   178m
kube-controller-manager-ddp1               1&#x2F;1     Running             5 (62m ago)   178m
kube-proxy-4vdmf                           1&#x2F;1     Running             0             146m
kube-proxy-58jvf                           1&#x2F;1     Running             1             147m
kube-proxy-jgqs6                           1&#x2F;1     Running             1 (62m ago)   177m
kube-scheduler-ddp1                        1&#x2F;1     Running             5 (62m ago)   178m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="å®‰è£…ingressæ’ä»¶"><a href="#å®‰è£…ingressæ’ä»¶" class="headerlink" title="å®‰è£…ingressæ’ä»¶"></a>å®‰è£…ingressæ’ä»¶</h3><p>Ingress æ˜¯ Kubernetes ä¸­ç”¨æ¥ç®¡ç†å¤–éƒ¨è®¿é—®é›†ç¾¤å†…æœåŠ¡ï¼ˆæ¯”å¦‚ HTTP/HTTPS æœåŠ¡ï¼‰çš„ API å¯¹è±¡ï¼Œå®ƒå……å½“ â€œæ™ºèƒ½æµé‡å…¥å£â€ æˆ– â€œåå‘ä»£ç†/è·¯ç”±è§„åˆ™é›†åˆâ€ï¼Œè®©ä½ å¯ä»¥é€šè¿‡ç»Ÿä¸€çš„å…¥å£ï¼ˆæ¯”å¦‚ä¸€ä¸ªåŸŸå + è·¯å¾„ï¼‰è®¿é—®å¤šä¸ªä¸åŒçš„ Serviceï¼Œé€šå¸¸æ­é… Ingress Controllerï¼ˆå¦‚ Nginxã€Traefikã€HAProxyï¼‰ä¸€èµ·ä½¿ç”¨ã€‚</p>
<p>åœ¨ Kubernetes ä¸­ï¼ŒIngress æ˜¯ä¸€ç§ API èµ„æºå¯¹è±¡ï¼Œå®ƒ å®šä¹‰äº†å¦‚ä½•å°†å¤–éƒ¨çš„ HTTP / HTTPS è¯·æ±‚è·¯ç”±åˆ°é›†ç¾¤å†…éƒ¨çš„ Serviceï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>å“ªä¸ªåŸŸåè®¿é—®å“ªä¸ªæœåŠ¡ï¼Ÿ </li>
<li>å“ªä¸ª URL è·¯å¾„ï¼ˆå¦‚ /apiã€/appï¼‰å¯¹åº”å“ªä¸ªåç«¯ï¼Ÿ </li>
<li>æ˜¯å¦å¯ç”¨ HTTPSï¼Ÿ </li>
<li>æ˜¯å¦åšè´Ÿè½½å‡è¡¡ã€é‡å®šå‘ã€rewrite ç­‰ï¼Ÿ<br>ä½†å®ƒ æœ¬èº«å¹¶ä¸æä¾›ç½‘ç»œä»£ç†åŠŸèƒ½ï¼Œå®ƒåªæ˜¯ â€œè§„åˆ™é…ç½®â€ï¼ŒçœŸæ­£å¹²æ´»çš„æ˜¯ï¼š</li>
</ul>
<p>ğŸ¤– Ingress Controllerï¼ˆå¦‚ Nginx Ingressã€Traefikã€HAProxyã€Caddy ç­‰ï¼‰</p>
<h4 id="Ingress-vs-LoadBalancer-vs-NodePort"><a href="#Ingress-vs-LoadBalancer-vs-NodePort" class="headerlink" title="Ingress vs LoadBalancer vs NodePort"></a>Ingress vs LoadBalancer vs NodePort</h4><table>
<thead>
<tr>
<th>æ–¹å¼</th>
<th>è¯´æ˜</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td>NodePort</td>
<td>æ¯ä¸ª Service ä¼šæš´éœ²ä¸€ä¸ªç«¯å£ï¼ˆå¦‚ 30001~32767ï¼‰ï¼Œé€šè¿‡ <NodeIP>:<Port> è®¿é—®</td>
<td>é€‚åˆæµ‹è¯•ï¼Œä¸æ¨èç”Ÿäº§</td>
</tr>
<tr>
<td>LoadBalancer</td>
<td>é€šè¿‡äº‘å‚å•†çš„è´Ÿè½½å‡è¡¡å™¨ï¼ˆå¦‚ AWS ALBã€GCP LBï¼‰æš´éœ²æœåŠ¡ï¼Œè‡ªåŠ¨åˆ†é…å¤–éƒ¨ IP</td>
<td>é€‚åˆäº‘ç¯å¢ƒï¼Œä½†æˆæœ¬è¾ƒé«˜ï¼Œé€šå¸¸ç”¨äº TCP/UDP æˆ–å•ä¸ªæœåŠ¡</td>
</tr>
<tr>
<td>Ingress</td>
<td>é€šè¿‡ HTTP/HTTPS åè®®ï¼ŒåŸºäº åŸŸåå’Œè·¯å¾„ æ™ºèƒ½è·¯ç”±åˆ°å¤šä¸ª Serviceï¼Œé€šå¸¸æ­é… Nginx ç­‰åå‘ä»£ç†</td>
<td>âœ… æœ€é€‚åˆ Web æœåŠ¡ã€å¤šæœåŠ¡ç»Ÿä¸€å…¥å£ã€ç”Ÿäº§ç¯å¢ƒ HTTP(S) æµé‡ç®¡ç†</td>
</tr>
</tbody></table>
<h4 id="ç¦»çº¿å®‰è£…"><a href="#ç¦»çº¿å®‰è£…" class="headerlink" title="ç¦»çº¿å®‰è£…"></a>ç¦»çº¿å®‰è£…</h4><p>åœ¨æ‰€æœ‰workerèŠ‚ç‚¹åŠ è½½é•œåƒ</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># æ‹‰å–é•œåƒ
docker pull docker pull k8s.gcr.io&#x2F;ingress-nginx&#x2F;controller:v1.1.2
docker pull k8s.gcr.io&#x2F;ingress-nginx&#x2F;kube-webhook-certgen:v1.1.1

# å¯¼å‡ºé•œåƒï¼ˆç”¨äºç¦»çº¿ä¼ è¾“ï¼‰
docker save -o controller-1.1.2.tar k8s.gcr.io&#x2F;ingress-nginx&#x2F;controller:v1.1.2
docker save -o kube-webhook-certgen-1.1.1.tar k8s.gcr.io&#x2F;ingress-nginx&#x2F;kube-webhook-certgen:v1.1.1

# åœ¨ç›®æ ‡èŠ‚ç‚¹å¯¼å…¥
docker load -i controller-1.1.2.tar
docker load -i kube-webhook-certgen-1.1.1.tar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨MasterèŠ‚ç‚¹ä¿®æ”¹ingress-nginx-4.0.18.tgzæ–‡ä»¶</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">tar -zxf ingress-nginx-4.0.18.tgz
    # externalIPs: []  #ä¿®æ”¹ä¸ºå¦‚ä¸‹å†…å®¹ï¼Œå€¼ä¸ºMasterèŠ‚ç‚¹çš„IP
    externalIPs:
      - 192.168.204.204
      
      # æ³¨é‡Šæ‰å¦‚ä¸‹ä¸¤è¡Œï¼Œå¦åˆ™å“ˆå¸Œå€¼æ£€æµ‹ä¸é€šè¿‡ï¼Œæ— æ³•å¯åŠ¨
      #digest: sha256:28b11ce69e57843de44e3db6413e98d09de0f6688e33d4bd384002a44f78405c
      #digest: sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660
tar -zcf ingress-nginx-4.0.18.tgz ingress-nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="å®‰è£…ingress"><a href="#å®‰è£…ingress" class="headerlink" title="å®‰è£…ingress"></a>å®‰è£…ingress</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;helm install ingress-nginx ingress-nginx-4.0.18.tgz  --namespace ingress-nginx   --create-namespace<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>é…ç½®Ingressç½‘ç»œ(æš‚æ— éœ€é…ç½®)</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubectl apply -f nginx-ingress-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: ingress-nginx-controller
spec:
  type: NodePort  # æ”¹ä¸º NodePort æˆ– LoadBalancerï¼ˆäº‘ç¯å¢ƒï¼‰
  ports:
    - name: http
      port: 80
      targetPort: 80
      nodePort: 30080  # æ‰‹åŠ¨æŒ‡å®š NodePortï¼ˆå¯é€‰ï¼‰
    - name: https
      port: 443
      targetPort: 443
      nodePort: 30443  # æ‰‹åŠ¨æŒ‡å®š NodePortï¼ˆå¯é€‰ï¼‰
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="K8Så®‰è£…Mysql"><a href="#K8Så®‰è£…Mysql" class="headerlink" title="K8Så®‰è£…Mysql"></a>K8Så®‰è£…Mysql</h2><p>MySQL æ˜¯ä¸€ä¸ªæœ‰çŠ¶æ€ã€æœ‰æ•°æ®çš„æœåŠ¡ï¼Œå®ƒçš„æ•°æ®éœ€è¦æŒä¹…åŒ–å­˜å‚¨ï¼Œä¸èƒ½åªå­˜åœ¨å®¹å™¨å†…ï¼ˆå› ä¸ºå®¹å™¨å¯èƒ½ä¼šè¢«é”€æ¯ã€è¿ç§»ï¼‰ã€‚<br>æ‰€ä»¥ï¼Œåœ¨ Kubernetes ä¸­è¿è¡Œ MySQLï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä¸ºå®ƒåˆ›å»ºä¸€ä¸ªï¼š<br><code>PersistentVolumeï¼ˆPVï¼‰</code>ï¼šè¡¨ç¤ºä¸€å—æŒä¹…åŒ–å­˜å‚¨èµ„æº<br><code>PersistentVolumeClaimï¼ˆPVCï¼‰</code>ï¼šè¡¨ç¤ºåº”ç”¨ï¼ˆå¦‚ MySQLï¼‰å¯¹å­˜å‚¨çš„éœ€æ±‚<br>ç„¶åé€šè¿‡ StorageClass(SC) æˆ–ç›´æ¥ä½¿ç”¨ NFS ç±»å‹çš„ PVï¼Œå°†æ•°æ®ä¿å­˜åˆ°æ¯”å¦‚ NFSã€äº‘ç›˜ã€æœ¬åœ°ç£ç›˜ç­‰å­˜å‚¨åç«¯<br><strong>å‰ææ¡ä»¶ï¼š</strong></p>
<ol>
<li>1 å° NFS æœåŠ¡å™¨ï¼ˆå¯ä»¥æ˜¯é›†ç¾¤å¤–çš„æœºå™¨ï¼Œä¹Ÿå¯ä»¥æ˜¯é›†ç¾¤ä¸­çš„æŸä¸€å°èŠ‚ç‚¹ï¼‰ ï¼Œè¿™å°æœºå™¨ä¸Š å®‰è£…å¹¶é…ç½®äº† NFS æœåŠ¡ç«¯ï¼ˆnfs-serverï¼‰ ï¼Œå®ƒä¼š å…±äº«å‡ºä¸€ä¸ªç›®å½•ï¼ˆæ¯”å¦‚ /mnt/data/mysqlï¼‰ï¼Œä¾› Kubernetes é›†ç¾¤ä¸­çš„èŠ‚ç‚¹æŒ‚è½½</li>
<li>Kubernetes çš„æ¯ä¸ªèŠ‚ç‚¹ï¼ˆè¿è¡Œ Pod çš„æœºå™¨ï¼‰éƒ½éœ€è¦å®‰è£… NFS å®¢æˆ·ç«¯å·¥å…·ï¼Œå¹¶ä¸”æ­£ç¡®é…ç½®ï¼Œèƒ½å¤ŸæŒ‚è½½ NFS å…±äº«ç›®å½•</li>
</ol>
<p>è®© Kubernetes é›†ç¾¤èƒ½å¤Ÿæ ¹æ®ä½ çš„éœ€æ±‚ï¼ˆæ¯”å¦‚é€šè¿‡ PVC è¯·æ±‚å­˜å‚¨ï¼‰ è‡ªåŠ¨ä¸ºä½ åŠ¨æ€åˆ›å»ºæŒä¹…åŒ–å­˜å‚¨ï¼ˆPVï¼‰ï¼Œè€Œæ— éœ€ä½ æ‰‹åŠ¨é¢„å…ˆåˆ›å»ºæ¯ä¸€ä¸ª PV<br>å¦‚æœåœ¨ Kubernetes ä¸­è¿è¡Œå¾ˆå¤šåº”ç”¨ï¼ˆæ¯”å¦‚ MySQLã€Redisã€åº”ç”¨æ•°æ®åº“ã€æ—¥å¿—æ”¶é›†ç­‰ï¼‰ï¼Œå®ƒä»¬éƒ½éœ€è¦ æŒä¹…åŒ–å­˜å‚¨ï¼ˆPersistentVolume, PVï¼‰ï¼Œç”¨æ¥ä¿å­˜æ•°æ®ã€‚</p>
<p>å¦‚æœä½¿ç”¨ é™æ€ PVï¼ˆæ‰‹åŠ¨åˆ›å»ºï¼‰ï¼š<br>éœ€è¦æå‰æ‰‹åŠ¨ä¸ºæ¯ä¸ªå¯èƒ½çš„å­˜å‚¨éœ€æ±‚åˆ›å»º PVï¼ˆæ¯”å¦‚å¤§å°ã€å­˜å‚¨ç±»å‹ã€è®¿é—®æ¨¡å¼ç­‰ï¼‰ ç„¶åå†åˆ›å»º PVC å»ç»‘å®š ï¼Œå¾ˆéº»çƒ¦ï¼Œä¸çµæ´»ï¼Œå®¹æ˜“æµªè´¹æˆ–ä¸å¤Ÿç”¨</p>
<p>StorageClass æ˜¯ Kubernetes ä¸­çš„ä¸€ç§ API èµ„æºï¼Œå®ƒå®šä¹‰äº†ï¼š</p>
<ol>
<li>â€œå½“ç”¨æˆ·æäº¤ PVC æ—¶ï¼Œå¦‚ä½•åŠ¨æ€åœ°åˆ›å»ºå‡ºå¯¹åº”çš„ PVï¼ˆæŒä¹…åŒ–å­˜å‚¨ï¼‰â€</li>
<li>å®ƒç›¸å½“äºä¸€ä¸ª â€œå­˜å‚¨æ¨¡æ¿â€ æˆ– â€œå­˜å‚¨ä¾›åº”å™¨é…ç½®â€</li>
</ol>
<h3 id="å®‰è£…å’ŒæŒ‚è½½NFS"><a href="#å®‰è£…å’ŒæŒ‚è½½NFS" class="headerlink" title="å®‰è£…å’ŒæŒ‚è½½NFS"></a>å®‰è£…å’ŒæŒ‚è½½NFS</h3><h4 id="å®‰è£…NFSæœåŠ¡ç«¯"><a href="#å®‰è£…NFSæœåŠ¡ç«¯" class="headerlink" title="å®‰è£…NFSæœåŠ¡ç«¯"></a>å®‰è£…NFSæœåŠ¡ç«¯</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># å®‰è£…NFSæœåŠ¡ç«¯
yum install -y nfs-utils # è¿™é‡Œæ‰€æœ‰æœåŠ¡å™¨éƒ½è¦å®‰è£…

# å®šä¹‰å…±äº«ç›®å½•åŠæƒé™
vi &#x2F;etc&#x2F;exports
&#x2F;data&#x2F;nfs_share 172.16.0.0&#x2F;16(rw,sync,no_subtree_check,no_root_squash) 
# æ ¼å¼ï¼š&lt;å…±äº«ç›®å½•&gt; &lt;å…è®¸çš„å®¢æˆ·ç«¯IP&#x2F;ç½‘æ®µ&gt;(æƒé™é€‰é¡¹)
# ç¤ºä¾‹ï¼šå…è®¸ 192.168.1.0&#x2F;24 è¯»å†™ï¼Œå…¶ä»–åªè¯»
mkdir -p &#x2F;data&#x2F;nfs_share
chmod 777 &#x2F;data&#x2F;nfs_share
# å¯åŠ¨æœåŠ¡ï¼Œåº”ç”¨exportsé…ç½®
systemctl start nfs-server rpcbind  # è¿™é‡Œåªéœ€è¦ä¸€å°æœåŠ¡å™¨å³å¯
systemctl enable nfs-server rpcbind # è¿™é‡Œåªéœ€è¦ä¸€å°æœåŠ¡å™¨å³å¯
exportfs -a #åŠ è½½é…ç½®ç”Ÿæ•ˆ # è¿™é‡Œåªéœ€è¦ä¸€å°æœåŠ¡å™¨å³å¯<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="é…ç½®NFSå®¢æˆ·ç«¯éªŒè¯NFSæŒ‚è½½ä½¿ç”¨"><a href="#é…ç½®NFSå®¢æˆ·ç«¯éªŒè¯NFSæŒ‚è½½ä½¿ç”¨" class="headerlink" title="é…ç½®NFSå®¢æˆ·ç«¯éªŒè¯NFSæŒ‚è½½ä½¿ç”¨"></a>é…ç½®NFSå®¢æˆ·ç«¯éªŒè¯NFSæŒ‚è½½ä½¿ç”¨</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># åˆ›å»ºæœ¬åœ°ç›®å½•
mkdir &#x2F;data&#x2F;nfs
# æŒ‚è½½è¿œç¨‹NFSç›®å½•
mkdir -p &#x2F;data&#x2F;nfs
mount -t nfs 172.16.7.135:&#x2F;data&#x2F;nfs_share &#x2F;data&#x2F;nfs
## éªŒè¯è¯»å†™
# å†™å…¥æ•°æ®åˆ°æœ¬åœ°æŒ‚è½½ç›®å½•
echo 111 &gt; &#x2F;data&#x2F;nfs&#x2F;test.txt 
# æŸ¥çœ‹NFSæœåŠ¡ç«¯ç›®å½•
cat &#x2F;data&#x2F;nfs_share&#x2F;test.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="é…ç½®åŠ¨æ€SC"><a href="#é…ç½®åŠ¨æ€SC" class="headerlink" title="é…ç½®åŠ¨æ€SC"></a>é…ç½®åŠ¨æ€SC</h3><h4 id="å®‰è£…NFS-Provisioner"><a href="#å®‰è£…NFS-Provisioner" class="headerlink" title="å®‰è£…NFS Provisioner"></a>å®‰è£…NFS Provisioner</h4><p>åˆ›å»º RBAC æƒé™<br>k8s-nfs-provisioner.yaml</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client
<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>sigs.io/nfs<span class="token punctuation">-</span>subdir<span class="token punctuation">-</span>external<span class="token punctuation">-</span>provisioner <span class="token comment"># æŒ‡å®šä¸€ä¸ªä¾›åº”å•†çš„åå­—</span>
<span class="token comment"># or choose another name, å¿…é¡»åŒ¹é… deployment çš„ env PROVISIONER_NAME'</span>
<span class="token key atrule">parameters</span><span class="token punctuation">:</span>
  <span class="token key atrule">archiveOnDelete</span><span class="token punctuation">:</span> <span class="token string">"false"</span> <span class="token comment"># åˆ é™¤ PV çš„æ—¶å€™ï¼ŒPV ä¸­çš„å†…å®¹æ˜¯å¦å¤‡ä»½</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
          <span class="token key atrule">image</span><span class="token punctuation">:</span> ccr.ccs.tencentyun.com/gcr<span class="token punctuation">-</span>containers/nfs<span class="token punctuation">-</span>subdir<span class="token punctuation">-</span>external<span class="token punctuation">-</span>provisioner<span class="token punctuation">:</span>v4.0.2
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /persistentvolumes
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVISIONER_NAME
              <span class="token key atrule">value</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>sigs.io/nfs<span class="token punctuation">-</span>subdir<span class="token punctuation">-</span>external<span class="token punctuation">-</span>provisioner
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_SERVER
              <span class="token key atrule">value</span><span class="token punctuation">:</span> 172.16.7.135 <span class="token comment"># NFS æœåŠ¡å™¨çš„åœ°å€</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_PATH
              <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/nfs_share <span class="token comment"># NFS æœåŠ¡å™¨çš„å…±äº«ç›®å½•</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root
          <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
            <span class="token key atrule">server</span><span class="token punctuation">:</span> 172.16.7.135
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/nfs_share
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"nodes"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumes"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"delete"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumeclaims"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storage.k8s.io"</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storageclasses"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"events"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span>
<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> run<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>locking<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"endpoints"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span>
<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>locking<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
  <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>locking<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å®‰è£…k8s-nfs-provisioner.yaml</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># å®‰è£…
kubectl apply -f  k8s-nfs-provisioner.yaml
# éªŒè¯ StorageClass
kubectl get storageclass<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="K8Så®‰è£…Mysql-1"><a href="#K8Så®‰è£…Mysql-1" class="headerlink" title="K8Så®‰è£…Mysql"></a>K8Så®‰è£…Mysql</h3><p><code>vi mysql-k8s.yaml</code></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token comment"># 1. MySQL Deployment</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>deployment
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
          <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">8.0</span>
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD
              <span class="token key atrule">value</span><span class="token punctuation">:</span> digiwin@123
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3307</span>
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>persistent<span class="token punctuation">-</span>storage
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/mysql
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>persistent<span class="token punctuation">-</span>storage
          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>pvc
<span class="token punctuation">---</span>
<span class="token comment"># 2. MySQL PVCï¼ˆæ˜¾å¼ä½¿ç”¨ nfs-client å­˜å‚¨ç±»ï¼‰</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>pvc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client  <span class="token comment"># ä½¿ç”¨ä½ éƒ¨ç½²çš„åŠ¨æ€ NFS å­˜å‚¨ç±»</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
<span class="token punctuation">---</span>
<span class="token comment"># 3. MySQL Serviceï¼ˆClusterIPï¼Œé›†ç¾¤å†…è®¿é—®ï¼‰</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>service
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3307</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3307</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å®‰è£…k8s-nfs-provisioner.yaml</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># å®‰è£…
kubectl apply -f  mysql-k8s.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>å¯åŠ¨åæŠ¥é”™ï¼š</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@ddp1 ~]# kubectl get pods
NAME                                     READY   STATUS         RESTARTS   AGE
mysql-deployment-557f98d759-4qzrp        0&#x2F;1     ErrImagePull   0          23s
nfs-client-provisioner-7f44f49d7-2ldbk   1&#x2F;1     Running        0          99m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ˜¯å› ä¸ºdocker æ‹‰å–é•œåƒæœ‰é—®é¢˜ï¼Œä¿®æ”¹dockeré•œåƒé…ç½®ï¼Œç„¶ååœ¨3å°æœåŠ¡å™¨ä¸Šéƒ½æå‰æ‰‹åŠ¨æ‹‰å–mysqlçš„é•œåƒ</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">vim &#x2F;etc&#x2F;docker&#x2F;daemon.json 
&#123;
&quot;registry-mirrors&quot;: [
                &quot;https:&#x2F;&#x2F;do.nark.eu.org&quot;,
                &quot;https:&#x2F;&#x2F;dc.j8.work&quot;,
                &quot;https:&#x2F;&#x2F;docker.m.daocloud.io&quot;,
                &quot;https:&#x2F;&#x2F;dockerproxy.com&quot;,
                &quot;https:&#x2F;&#x2F;docker.mirrors.ustc.edu.cn&quot;,
                &quot;https:&#x2F;&#x2F;docker.nju.edu.cn&quot;
    ],

&quot;exec-opts&quot;: [&quot;native.cgroupdriver&#x3D;systemd&quot;]
&#125;
systemctl daemon-reload
systemctl restart docker
docker pull mysql:8.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é‡æ–°æ‰§è¡Œå‘½ä»¤ï¼š</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubectl apply -f  mysql-k8s.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>è¿˜æ˜¯æŠ¥é”™ï¼š</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@ddp1 ~]# kubectl get pods
NAME                                     READY   STATUS             RESTARTS        AGE
mysql-deployment-587b8dc4d8-vcfsd        0&#x2F;1     CrashLoopBackOff   1 (7s ago)      11s
nfs-client-provisioner-7f44f49d7-2ldbk   1&#x2F;1     Running            2 (4m35s ago)   165m
[root@ddp1 ~]# kubectl describe pod mysql-deployment-587b8dc4d8-vcfsd
Events:
  Type     Reason            Age                From               Message
  ----     ------            ----               ----               -------
  Warning  FailedScheduling  71s                default-scheduler  0&#x2F;3 nodes are available: 3 pod has unbound immediate PersistentVolumeClaims.
  Normal   Scheduled         70s                default-scheduler  Successfully assigned default&#x2F;mysql-deployment-587b8dc4d8-vcfsd to ddp2
  Normal   Pulled            27s (x4 over 69s)  kubelet            Container image &quot;mysql:8.0&quot; already present on machine
  Normal   Created           26s (x4 over 69s)  kubelet            Created container mysql
  Normal   Started           26s (x4 over 69s)  kubelet            Started container mysql
  Warning  BackOff           12s (x6 over 67s)  kubelet            Back-off restarting failed container

kubectl logs mysql-deployment-7f44f49d7-2ldbk 
2025-08-25 06:43:38+00:00 [Note] [Entrypoint]: Entrypoint script for MySQL Server 8.0.43-1.el9 started.
chown: changing ownership of &#39;&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;&#39;: Operation not permitted
chown: changing ownership of &#39;&#x2F;var&#x2F;lib&#x2F;mysql&#39;: Operation not permitted<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™æ˜¯å› ä¸ºNFS ä¸ Kubernetes æŒ‚è½½æ—¶æ¶‰åŠçš„æƒé™é—®é¢˜<br>Kubernetes æŒ‚è½½ NFS ç±»å‹çš„ PVï¼ˆé€šè¿‡ PVCï¼‰æ—¶ï¼š</p>
<ul>
<li>ä½¿ç”¨çš„æ˜¯ åŠ¨æ€å­˜å‚¨ Provisionerï¼ˆå¦‚ nfs-subdir-external-provisionerï¼‰</li>
<li>å®ƒä¼šåœ¨ä½ æŒ‡å®šçš„ NFS æœåŠ¡ç«¯å…±äº«ç›®å½•ï¼ˆæ¯”å¦‚ /data/nfs_shareï¼‰ä¸‹ï¼ŒåŠ¨æ€åˆ›å»ºä¸€ä¸ªå­ç›®å½•ï¼ˆä¾‹å¦‚ï¼š/data/nfs_share/default-mysql-pvc-xxxxxï¼‰</li>
<li>ç„¶å Kubernetes ä¼šæŠŠè¿™ä¸ªå­ç›®å½•ä½œä¸º <strong>PVï¼ŒæŒ‚è½½åˆ°å®¹å™¨å†…çš„ /var/lib/mysql</strong></li>
<li>*è¡¨é¢ä¸Šï¼š** æ˜¯ Kubernetes Pod ä¸­çš„ mysql å®¹å™¨ï¼ˆé€šå¸¸æ˜¯ root ç”¨æˆ·å¯åŠ¨ï¼Œæˆ–ä»¥ mysql ç”¨æˆ·è¿è¡Œï¼‰</li>
<li>*å®é™…ä¸Šï¼š** æ˜¯è¯¥å®¹å™¨é€šè¿‡ NFS æŒ‚è½½è®¿é—®æœåŠ¡ç«¯çš„å…±äº«ç›®å½•</li>
<li>*å…³é”®ç‚¹ï¼š**<br> NFS æœåŠ¡ç«¯ä¼šå¯¹è®¿é—®çš„ç”¨æˆ·è¿›è¡Œ UID/GID æ˜ å°„ï¼Œå¦‚æœ NFS æœåŠ¡ç«¯å¯ç”¨äº† root_squashï¼ˆé»˜è®¤é€šå¸¸æ˜¯å¯ç”¨çš„ï¼ï¼‰ï¼Œé‚£ä¹ˆï¼š æ¥è‡ªå®¢æˆ·ç«¯çš„ root ç”¨æˆ·ï¼ˆUID 0ï¼‰ï¼Œåœ¨è®¿é—® NFS å…±äº«ç›®å½•æ—¶ï¼Œä¼šè¢«æ˜ å°„ä¸ºåŒ¿åç”¨æˆ·ï¼ˆé€šå¸¸æ˜¯ nobody æˆ– nfsnobodyï¼ŒUID 65534 æˆ–ç±»ä¼¼ï¼‰ï¼Œæ²¡æœ‰å†™æƒé™ï¼</li>
</ul>
<p>è¿™å°±å¯¼è‡´ï¼š<br>å³ä½¿ä½ åœ¨å®¹å™¨ä¸­æ˜¯ rootï¼Œåœ¨ NFS æœåŠ¡ç«¯çœ‹æ¥ï¼Œä½ å¯èƒ½åªæ˜¯ä¸ªæ²¡æœ‰æƒé™çš„åŒ¿åç”¨æˆ·<br>æ‰€ä»¥ä½ æ— æ³•åœ¨ NFS ç›®å½•ä¸­åˆ›å»ºæ–‡ä»¶ã€ä¿®æ”¹å±ä¸»ã€åˆå§‹åŒ– MySQL æ•°æ®ç­‰æ“ä½œï¼</p>
<p>å› æ­¤ï¼Œè‹¥ä½¿ç”¨ NFS ä½œä¸ºæŒä¹…åŒ–å­˜å‚¨ï¼Œéœ€æ£€æŸ¥ NFS æœåŠ¡ç«¯é…ç½®ï¼Œç¡®ä¿æ·»åŠ  no_root_squash é€‰é¡¹ä»¥å…è®¸ root ç”¨æˆ·æ“ä½œå…±äº«ç›®å½•<br>5ã€‚ä¿®æ”¹åéœ€é‡å¯ NFS æœåŠ¡</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">vim &#x2F;etc&#x2F;exports
&#x2F;data&#x2F;nfs_share 172.16.0.0&#x2F;16(rw,sync,no_subtree_check,no_root_squash) # å¢åŠ no_root_squash
systemctl restart rpcbind &amp;&amp; systemctl restart nfs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>å†æ¬¡é‡æ–°å®‰è£…ï¼š</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubectl delete -f  mysql-k8s.yaml 
kubectl apply -f  mysql-k8s.yaml 
[root@ddp1 ~]# kubectl get pods
NAME                                     READY   STATUS    RESTARTS      AGE
mysql-deployment-587b8dc4d8-xdccx        1&#x2F;1     Running   0             13m
nfs-client-provisioner-7f44f49d7-2ldbk   1&#x2F;1     Running   2 (35m ago)   3h16m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åˆ°æ­¤ï¼ŒæœåŠ¡æ­£å¸¸å¯åŠ¨äº†<br>ä½†æ˜¯é€šè¿‡telnetæ— æ³•è¿é€šmysqlï¼Œå› ä¸ºService æ˜¯ ClusterIP ç±»å‹ï¼Œåªèƒ½è¢«é›†ç¾¤å†…çš„å…¶ä»– Pod è®¿é—®ï¼Œå¦‚æœæƒ³è¦åœ¨å®¹å™¨å¤–è¢«è®¿é—®ï¼Œéœ€è¦ä½¿ç”¨NodePort</p>
<p>æŸ¥çœ‹é›†ç¾¤æœ‰å“ªäº› Service</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@ddp1 ~]# kubectl get svc
NAME            TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE
kubernetes      ClusterIP   10.0.0.1      &lt;none&gt;        443&#x2F;TCP    3d
mysql-service   ClusterIP   10.8.235.95   &lt;none&gt;        3307&#x2F;TCP   16m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯ä»¥çœ‹åˆ°æ˜¯ClusterIPç±»å‹</p>
<p>å¯ä»¥è¿›å…¥å®¹å™¨å†…å»æ“ä½œmysqlï¼š</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubectl exec -it mysql-deployment-587b8dc4d8-xdccx -- bash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>è‡³æ­¤ï¼ŒmysqlæœåŠ¡å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Kubernetes/" rel="tag"># Kubernetes</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/08/20/Ambari%E8%87%AA%E5%AE%9A%E4%B9%89%E6%9C%8D%E5%8A%A1/" rel="prev" title="Ambariè‡ªå®šä¹‰æœåŠ¡">
      <i class="fa fa-chevron-left"></i> Ambariè‡ªå®šä¹‰æœåŠ¡
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Centos%E5%AE%89%E8%A3%85k8s%E9%9B%86%E7%BE%A4"><span class="nav-number">1.</span> <span class="nav-text">Centoså®‰è£…k8sé›†ç¾¤</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E7%8E%AF%E5%A2%83%E8%AF%B4%E6%98%8E"><span class="nav-number">1.1.</span> <span class="nav-text">å®‰è£…ç¯å¢ƒè¯´æ˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-number">1.2.</span> <span class="nav-text">ç¯å¢ƒå‡†å¤‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85docker"><span class="nav-number">1.3.</span> <span class="nav-text">å®‰è£…docker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85kubeadm-kubelet%E5%92%8Ckubectl"><span class="nav-number">1.4.</span> <span class="nav-text">å®‰è£…kubeadm,kubeletå’Œkubectl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2Kubernetes-Master%E8%8A%82%E7%82%B9"><span class="nav-number">1.5.</span> <span class="nav-text">éƒ¨ç½²Kubernetes MasterèŠ‚ç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2worker%E8%8A%82%E7%82%B9"><span class="nav-number">1.6.</span> <span class="nav-text">éƒ¨ç½²workerèŠ‚ç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8E%E7%BB%AD%E9%85%8D%E7%BD%AE"><span class="nav-number">1.7.</span> <span class="nav-text">åç»­é…ç½®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85Calico%E6%8F%92%E4%BB%B6"><span class="nav-number">1.8.</span> <span class="nav-text">å®‰è£…Calicoæ’ä»¶</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85%EF%BC%9A"><span class="nav-number">1.8.1.</span> <span class="nav-text">ç¦»çº¿å®‰è£…ï¼š</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8%E7%BA%BF%E5%AE%89%E8%A3%85"><span class="nav-number">1.8.2.</span> <span class="nav-text">åœ¨çº¿å®‰è£…</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8Bpod%E5%AE%89%E8%A3%85%E6%83%85%E5%86%B5"><span class="nav-number">1.8.3.</span> <span class="nav-text">æŸ¥çœ‹podå®‰è£…æƒ…å†µ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85ingress%E6%8F%92%E4%BB%B6"><span class="nav-number">1.9.</span> <span class="nav-text">å®‰è£…ingressæ’ä»¶</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Ingress-vs-LoadBalancer-vs-NodePort"><span class="nav-number">1.9.1.</span> <span class="nav-text">Ingress vs LoadBalancer vs NodePort</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85"><span class="nav-number">1.9.2.</span> <span class="nav-text">ç¦»çº¿å®‰è£…</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85ingress"><span class="nav-number">1.9.3.</span> <span class="nav-text">å®‰è£…ingress</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#K8S%E5%AE%89%E8%A3%85Mysql"><span class="nav-number">2.</span> <span class="nav-text">K8Så®‰è£…Mysql</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E5%92%8C%E6%8C%82%E8%BD%BDNFS"><span class="nav-number">2.1.</span> <span class="nav-text">å®‰è£…å’ŒæŒ‚è½½NFS</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85NFS%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-number">2.1.1.</span> <span class="nav-text">å®‰è£…NFSæœåŠ¡ç«¯</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AENFS%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%AA%8C%E8%AF%81NFS%E6%8C%82%E8%BD%BD%E4%BD%BF%E7%94%A8"><span class="nav-number">2.1.2.</span> <span class="nav-text">é…ç½®NFSå®¢æˆ·ç«¯éªŒè¯NFSæŒ‚è½½ä½¿ç”¨</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E5%8A%A8%E6%80%81SC"><span class="nav-number">2.2.</span> <span class="nav-text">é…ç½®åŠ¨æ€SC</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85NFS-Provisioner"><span class="nav-number">2.2.1.</span> <span class="nav-text">å®‰è£…NFS Provisioner</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#K8S%E5%AE%89%E8%A3%85Mysql-1"><span class="nav-number">2.3.</span> <span class="nav-text">K8Så®‰è£…Mysql</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Golden"
      src="/uploads/avatar.jpg">
  <p class="site-author-name" itemprop="name">Golden</p>
  <div class="site-description" itemprop="description">è®¡åˆ’æ¨åŠ¨å˜åŒ–</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">98</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">68</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">69</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2021 â€“ 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Golden</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'SkWNsftcFwwI7sR8WGnbm8G0-gzGzoHsz',
      appKey     : 'wHfJCMCqkaxidT5nJyOygkO7',
      placeholder: "Just go go",
      avatar     : 'wavatar',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
